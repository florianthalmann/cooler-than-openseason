function ChannelBus(e,t){function n(e){$.ajax({type:"GET",url:"/script/lib/tuna/impulses/ir_rev_short.wav",processData:!1,dataType:"arraybuffer",success:function(t){Sound.audioContext.decodeAudioData(t,function(t){e.buffer=t})}})}if(this.input=Sound.audioContext.createGain(),this.output=Sound.audioContext.createGain(),0!=t){var i=Sound.audioContext.createPanner();i.setPosition(t,0,-.5)}i?(this.input.connect(i),i.connect(this.output)):this.input.connect(this.output),this.output.gain.value=e,this.connect=function(e){this.output.connect(e)}}function FadeableSource(e,t,n,i){this.output=Sound.audioContext.createGain(),this.output.gain.value=t,this.source=Sound.audioContext.createBufferSource(),this.source.buffer=e,this.source.connect(this.output);var o=Math.pow(Math.pow(2,1/12),n-60);this.source.playbackRate.value=o,this.source.start(i),this.fadeOutAndStop=function(e){(!e||e<=Sound.audioContext.currentTime)&&(e=Sound.audioContext.currentTime),this.output.gain.setValueAtTime(this.output.gain.value,e),this.output.gain.linearRampToValueAtTime(0,e+Sound.GAIN_FADE_TIME),this.source.stop(e+Sound.GAIN_FADE_TIME)},this.connect=function(e){this.output.connect(e)}}function PlayedMidiFile(e,t){this.playEventsBefore=function(n){for(var i=60/Midi.tempo/e.header.ticksPerBeat,o=0;o<e.tracks.length;o++)for(;this.currentTrackPositions[o]<e.tracks[o].length;){var a=e.tracks[o][this.currentTrackPositions[o]],r=this.currentTrackEventTimes[o]+a.deltaTime*i,s=Midi.startingTime+r+Midi.SCHEDULING_OFFSET;if(!(n>=s))break;if("noteOn"===a.subtype){var u=a.velocity/127,d=a.noteNumber;Sound.playSoundAt(s,t,u,d)}this.currentTrackPositions[o]++,this.currentTrackEventTimes[o]=r}},this.reset=function(){this.currentTrackPositions=[],this.currentTrackEventTimes=[];for(var t=0;t<e.tracks.length;t++)this.currentTrackPositions.push(0),this.currentTrackEventTimes.push(0)},this.reset()}$.ajaxSetup({}),$.ajaxTransport("+*",function(e,t,n){return window.FormData&&(e.dataType&&("blob"===e.dataType||"arraybuffer"===e.dataType)||e.data&&(window.Blob&&e.data instanceof Blob||window.ArrayBuffer&&e.data instanceof ArrayBuffer))?{send:function(t,n){var i=new XMLHttpRequest,o=e.url||window.location.href,a=e.type||"GET",r=e.dataType||"text",s=e.data||null,u=e.async||!0,d;i.addEventListener("load",function(){var e={},t,o;o=i.status>=200&&i.status<300||304===i.status,o?e[r]=i.response:e.text=String.fromCharCode.apply(null,new Uint8Array(i.response)),n(i.status,i.statusText,e,i.getAllResponseHeaders())}),i.open(a,o,u),i.responseType=r;for(d in t)t.hasOwnProperty(d)&&i.setRequestHeader(d,t[d]);i.send(s)},abort:function(){n.abort()}}:void 0});var User={username:"",openUsername:"",openVersion:1,sessionRunning:function(){var e="";return $.ajax({type:"get",url:"/php/ajax.user.php",data:"checkSession=true",dataType:"json",async:!1,success:function(t){t.success&&(e=t.success)}}),this.username=e,e},logout:function(){$.ajax({type:"get",url:"/php/ajax.user.php",data:"logout=true",dataType:"json",async:!1,success:function(e){e.success}})}},Sound={recorder:null,recordingSoundIndex:0,audioContext:{},tuna:{},sounds:[],channels:[],sources:[],MAX_RECORDING_TIME:3e3,GAIN_FADE_TIME:.05,startRecorder:function(e){Sound.recordingSoundIndex=e,Sound.recorder.clear(),Sound.recorder.record(Sound.MAX_RECORDING_TIME,Sound.stoppedRecording)},stopRecorder:function(){Sound.recorder&&(Sound.recorder.stop(),Sound.stoppedRecording())},stoppedRecording:function(){function e(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}var t=Sound.recorder;t&&(Sound.recorder.getBuffer(function(e){var n=Sound.audioContext.createBuffer(1,e[0].length,Sound.audioContext.sampleRate);n.getChannelData(0).set(e[0]),Sound.sounds[Sound.recordingSoundIndex]=n,t.exportWAV(function(e){Sound.saveSoundFile(Sound.recordingSoundIndex,e)})}),t.disconnect(),Sound.recorder=null),$('[id^="record'+e(Sound.recordingSoundIndex,2)+'"]').removeClass("active")},saveSoundFile:function(e,t){var n=e+".wav",i=new FormData;i.append("data",t,n),$.ajax({type:"POST",url:"/php/ajax.upload.php",data:i,cache:!1,processData:!1,contentType:!1,success:function(e){},beforeSend:function(){$('[data-index="'+e+'"] .track-status').show()},complete:function(){$('[data-index="'+e+'"] .track-status').fadeOut(200)},error:function(e,t,n){console.log(n)}})},loadSoundFile:function(e,t){var n=!1;13==t&&(n=!0),$.ajax({type:"GET",url:e,processData:!1,dataType:"arraybuffer",cache:n,success:function(e){Sound.audioContext.decodeAudioData(e,function(e){Sound.sounds[t]=e})},beforeSend:function(){13==t?$(".global-status").show():$('[data-index="'+t+'"] .track-status').show()},complete:function(){13==t?$(".global-status").fadeOut(1e3):$('[data-index="'+t+'"] .track-status').fadeOut(200)}})},loadUserSoundFiles:function(e,t,n){for(var i=0;e>i;i++)this.loadUserSoundFile(i,t,n)},loadUserSoundFile:function(e,t,n){var i="/userfiles/"+t+"/"+e+".wav";this.loadSoundFile(i,e)},deleteSoundAt:function(e){if(this.sounds[e]){this.sounds[e]=null;var t=e+".wav";$.ajax({type:"POST",data:{action:"deletefile",filename:t},url:"/php/ajax.delete.php",success:function(e){}})}},playSoundAt:function(e,t,n,i){i||(i=60),this.sounds[t]&&(this.sources[t]&&e>0&&this.sources[t].fadeOutAndStop(e-this.GAIN_FADE_TIME-.01),this.sources[t]=new FadeableSource(this.sounds[t],n,i,e),this.sources[t].connect(this.channels[t].input))},stopAllSounds:function(){var e;for(e=0;e<this.sources.length;e++)this.sources[e]&&this.sources[e].fadeOutAndStop(0);this.sources=[]}},Midi={tempo:125,midiFiles:[],LOOK_AHEAD:25,SCHEDULE_AHEAD_TIME:.1,SCHEDULING_OFFSET:.1,timerID:0,startingTime:0,isPlaying:!1,togglePlaySong:function(){this.isPlaying?this.stopPlaying():this.startPlaying()},startPlaying:function(){this.startingTime=Sound.audioContext.currentTime,this.scheduleMidiEvents(),this.isPlaying=!0},stopPlaying:function(){this.stopMidiScheduling(),Sound.stopAllSounds(),this.isPlaying=!1},scheduleMidiEvents:function(){for(var e=0;e<Midi.midiFiles.length;e++)Midi.midiFiles[e].playEventsBefore(Sound.audioContext.currentTime+Midi.SCHEDULE_AHEAD_TIME);Midi.timerID=window.setTimeout(Midi.scheduleMidiEvents,Midi.LOOK_AHEAD)},stopMidiScheduling:function(){window.clearTimeout(Midi.timerID);for(var e=0;e<Midi.midiFiles.length;e++)Midi.midiFiles[e].reset()},loadMidiFile:function(e,t){var n=new XMLHttpRequest;n.open("GET",e+"?"+(new Date).getTime()),n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(){if(4===this.readyState&&200===this.status){for(var e=this.responseText||"",n=[],i=e.length,o=String.fromCharCode,a=0;i>a;a++)n[a]=o(255&e.charCodeAt(a));t(n.join(""))}},n.send()}},UI={container:"#container",delegate:"#container"};$(function(){UI.container=$(UI.container),UI.delegate=$(UI.delegate),UI.container.load("/nopermission.html"),$("#message").click(function(){$(this).fadeOut()}),UI.delegate.on("click",'[id^="record"]',function(e){e.preventDefault();var t=parseInt($(e.target).attr("id").slice(-2));$(this).hasClass("active")||Sound.recorder?(Sound.stopRecorder(),$(this).removeClass("active")):(Sound.recorder=new Recorder(window.mediaStreamSource),Sound.startRecorder(t),$(this).addClass("active"))}),UI.delegate.on("mousedown",'[id^="play"]',function(e){var t=parseInt($(e.target).attr("id").slice(-2));Sound.playSoundAt(0,t,1)}),UI.delegate.on("mousedown",'[id^="delete"]',function(e){var t=parseInt($(e.target).attr("id").slice(-2));Sound.deleteSoundAt(t)}),UI.delegate.on("click","button#song",function(e){e.preventDefault(),Midi.togglePlaySong(),Midi.isPlaying?$(this).addClass("active"):$(this).removeClass("active")}),UI.delegate.on("click","#toggle-share",function(e){var t=$("#share-menu");t.slideToggle("fast",function(){$("#toggle-share span").html("none"==t.css("display")?"Share!":"Close")})}),UI.delegate.on("click",".share-link",function(e){var t,n,i=355,o=500;t=window.screen.width/2-(o/2+10),n=window.screen.height/2-(i/2+50);var a="status=no,height="+i+",width="+o+",resizable=yes,left="+t+",top="+n+",screenX="+t+",screenY="+n+",toolbar=no,menubar=no,scrollbars=yes,location=yes,directories=no",r=this.href;window.open(r,"sharer",a),e.preventDefault()})}),$(function(){function e(){""!==User.sessionRunning()?$("#container").load("/main.html",function(){i(User.username,User.openVersion,!1)}):$("#container").load("/signup.html",function(){t()})}function t(){n(),$("#container").on("click","#goto-login",function(e){e.preventDefault(),$("#container").load("/login.html",function(){r()})}),$("#container").on("submit","#form-signup",function(e){e.preventDefault();var t=new FormData($("#form-signup")[0]);$.ajax({type:"POST",url:"/php/ajax.user.php",processData:!1,contentType:!1,data:t,success:function(e){e.success?$("#container").load("/main.html",function(){i(User.username,User.openVersion,!1)}):$("#message").html(e.error).show()}})})}function n(){$.ajax({type:"GET",url:"/php/ajax.recentusers.php",dataType:"json",success:function(e){e.usernames.forEach(function(e,t){var n=$(".recent-users li").first().clone();n.find(".userlink").attr("onclick","location.href='/"+e+"'"),n.find(".userlink").html(e),$(".recent-users").append(n)}),$(".recent-users li").first().remove()}})}function i(e,t,n){if(n)o(e,t,n);else if(a(),!c)try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({audio:!0},function(i){c=i,$("#container").load("/main.html",function(){o(e,t,n)})},function(){a()})}catch(i){a()}}function o(e,t,i){i||($("#message").html('<strong>INSTRUCTIONS</strong><br><br><img src="/img/instruct-record.png"> Record your sounds and play them loud along the track <img src="/img/instruct-play.png"><br><img src="/img/instruct-share.png"> Share your hip-shaking masterpiece with your friends!<br>Open Season loves you!<br><br>Tap/click to close instructions...').show(),n()),window.AudioContext=window.AudioContext||window.webkitAudioContext,Sound.audioContext=new AudioContext,Sound.tuna=new Tuna(Sound.audioContext),c&&(window.mediaStreamSource=Sound.audioContext.createMediaStreamSource(c));var o=13;Sound.sounds[o]||u("/script/midi/wedancemix.mid",o,!1,null,1,0,"/script/audio/wedancemix.mp3"),s(e,t,i),$("#producer-name").html(e)}function a(){$("#container").load("/nopermission.html")}function r(){$("#container").on("click","#goto-signup",function(e){e.preventDefault(),$("#container").load("signup.html",function(){t()})}),$("#container").on("submit","#form-login",function(e){e.preventDefault();var t=new FormData($("#form-login")[0]);$.ajax({type:"POST",url:"/php/ajax.user.php",processData:!1,contentType:!1,data:t,success:function(e){e.success?$("#container").load("/main.html",function(){i(e.success)}):$("#message").html(e.error).show()}})})}function s(e,t,n){if(u("/script/midi/wedancebassdrum.mid",0,!n,"Bassdrum",.55,0),u("/script/midi/wedancesnare.mid",1,!n,"Snare",.5,0),u("/script/midi/wedancehihat.mid",2,!n,"Hihat",.35,.15),u("/script/midi/wedancetom.mid",3,!n,"Tom",.35,-.15),u("/script/midi/wedanceshaker.mid",4,!n,"Shaker",.25,-.3),u("/script/midi/wedanceclap.mid",5,!n,"Clap",.3,-.1),u("/script/midi/wedancehey.mid",6,!n,"Hey",.3,.1),u("/script/midi/wedanceyeah.mid",7,!n,"Yeah",.3,.2),u("/script/midi/wedanceyo.mid",8,!n,"Yo",.3,-.2),u("/script/midi/wedancename.mid",9,!n,"Producer name",.35,.1),u("/script/midi/wedancehome.mid",10,!n,"Hometown",.35,-.05),u("/script/midi/wedancedrink.mid",11,!n,"Favorite drink",.35,-.1),u("/script/midi/wedancemusic.mid",12,!n,"Favorite music",.35,.1),$(".tracklist li").first().remove(),Sound.loadUserSoundFiles(13,e,t),n)$(".share").hide(),$("#toggle-share").css("visibility","hidden"),$("#are-you-cooler").html("Are you cooler than "+e+"?"),$(".make-your-own-area").show(),$(".competition").hide();else{$(".make-your-own-area").hide(),$(".competition").show();var i=window.location.hostname+"/"+e;$(".share-link").each(function(){var e=$(this).attr("href");$(this).attr("href",e+"http://"+i)}),$(".share").show()}}function u(e,t,n,i,o,a,r,s){if(n){var u=d(t,2),c=$(".tracklist li").first().clone();c.find("#record").attr("id","record"+u),c.find("#play").attr("id","play"+u),c.find("#delete").attr("id","delete"+u),c.find(".track-name").html(i),c.attr("data-index",t),$(".tracklist").append(c)}Midi.loadMidiFile(e,function(e){Midi.midiFiles.push(new PlayedMidiFile(MidiFile(e),t))}),r&&Sound.loadSoundFile(r,t,s),Sound.channels[t]=new ChannelBus(o,a),Sound.channels[t].connect(Sound.audioContext.destination)}function d(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}var c=null;$("body").data("open-username")?(User.openUsername=$("body").data("open-username"),User.openVersion=$("body").data("open-version")):(User.openUsername="",User.openVersion=1),""!==User.openUsername?$("#container").load("/main.html",function(){i(User.openUsername,User.openVersion,!0)}):e()});
//# sourceMappingURL=./app.min.js.map